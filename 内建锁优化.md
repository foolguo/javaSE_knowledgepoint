# 内建锁优化

内建锁的优化并没有优化加锁和解锁的过程，而是优化了每个线程的等待时间



首先来介绍一下CAS（无锁状态）

## CAS

1.什么是CAS？

CAS：全称Compare And Swap 比较交换技术

CAS是一种乐观锁机制，所谓乐观锁就是从始至终只有一个线程尝试获取锁，既然只有一个线程就不需要加锁了。

CAS获取锁的过程：有三个值 V内存中的值，O期望的值 ，N要替换的值。

若V==O，说明没有其他线程获取过锁，直接将V替换成N。

若V！=O，说明有其他线程获取锁，返回V值

**元老级的内建锁的问题（JDK1.6之前）：**

每当有线程竞争锁，竞争成功的线程会阻塞竞争失败的线程，这样就带来了线程阻塞和唤醒的性能问题。

**优化：**

CAS不是将竞争锁失败的线程武断挂起（阻塞），而是让其自旋尝试获取锁，到了一定的次数再挂起。

具体过程：采用了一个自适应自旋的过程，如果上次自旋获取到锁，这次就自旋稍微长一点；如果上次自旋没有获取到锁，这次就自旋短一些。

**CAS问题**

**ABA问题：**

ABA问题：线程1 A 线程2 A—>B 线程3 B—>A 线程1 : ???

理论上来说 线程1是可以修改的，但是如果修改了，线程3就会瘫痪。

解决思路：数据库的乐观锁机制，加入一个版本号： 包java.util.concurrent.atomic的 AtomicReference类

公平性问题：处于自旋状态的线程会比阻塞状态的线程更容易获取锁。

在同步代码块中，获得对象monitor监视器就是获得了对象的锁。无非就是对象的锁就是对象头里的一个标记



## 对象头

1.如何理解对象的锁？

获取对象的锁实际上就是获取对象监视器monitor。对象锁就是对象的一个标志，这个标志存放在对象头中。

对象头的mark word里默认存放了hash code 分代年龄，锁标记位。在JDK1.6后锁有四种状态

从低到高是：无锁状态，偏向锁，轻量级锁，重量级锁。

并且这几个状态可以升级，但是不能降级。 为了提高获取和释放锁的效率。



## 偏向锁

HotSpot的作者发现，在大多是情况下，锁时不存在竞争的，并且总是由一把锁获取。为了线程获取锁的代价更低引入偏向锁。

偏向锁：在任何时间，只有一个线程请求一把锁。

**锁的获取：**

1.当有线程访问同步代码块并尝试获取锁，对象头和栈帧中的锁记录存储锁偏向的线程。以后再进入和退出同步代码块是，只需要测试一下，对象头的的mark是否存储着当前线程ID。测试成功直接进入同步代码块

2.如果测试失败，看偏向锁字段，如果为0，说明当前没有任何线程访问偏向锁，将mark word的线程ID改成自己的，并将偏向锁字段设置为1.

3.如果为1，说明当前已经有线程获取到了偏向锁，不断自旋尝试获取偏向锁（后者可能性较大）。

偏向锁每撤销一次，mark word中的 epoch字段就加1，如果epoch==40，说明此时该锁已经不适合做偏向锁了，膨胀成轻量级锁。

**锁的撤销：**

偏向锁采用了一种竞争才会释放锁的机制，只有当其他线程尝试获取偏向锁，持有偏向锁的线程才会释放偏向锁。

1.偏向锁的撤销必须要到达全局安全点（CPU上没有运行任何有用字节码）

2.暂停拥有锁的线程，并看当前线程是否活着， 如果线程处于不活动状态将 ，对象头设置成无锁状态；如果线程依旧活着，拥有偏向锁的栈会被执行，遍历对象的锁记录和对象头的markword ，锁要么被设置为无锁状态，要么偏向另一个线程，或者不适和做偏向锁，膨胀成轻量级锁。             



## 轻量级锁 

在不同时间，有不同线程尝试获取同一对象锁。

**加锁：**

1.线程访问同步代码块并且尝试获取锁，JVM会在线程的栈帧中开辟一块存放锁记录的空间，将对象头的mark word直接复制到此空间中  。被称为Displace mark word。

2.采用CAS将对象头的markword替换成指向锁记录的指针。

3.如果成功则说明，当前没有线程竞争锁，加锁成功。否则，不断自旋尝试获取偏向锁。****

**解锁：**

1.解锁时，将Displace mark word复制回对象头中，如果成功，解锁成功，如果失败，说明有线程竞争轻量级锁，锁直接膨胀成重量级锁。



##总结 

重量级锁：重量级锁采用一种自适应自旋的方法，来避免线程在运行非常小的同步代码块还会被阻塞。适用于同一时刻有多个线程尝试获取锁。

轻量级锁：CAS操作，将锁对象的标记字段替换成一个指针，指向线程的一块空间，存储锁对象原来标记的字段。多个线程在不同时间获取锁。

偏向锁：只会在第一次请求时采用CAS操作，在锁对象的标记字段中记录下 当前线程的地址，以后运行持有偏向锁持有线程不再有加锁过程，锁被同一线程持有。